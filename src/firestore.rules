rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE AYUDA ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // Busca el documento usando el UID exacto del usuario logueado
    function getUserData() {
      return get(/databases/$(database)/documents/employees/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('ADMIN');
    }

    function isDoctor() {
      return hasRole('DOCTOR') || hasRole('OPTOMETRIST') || isAdmin();
    }
    
    function isSales() {
      return hasRole('SALES') || isAdmin();
    }

    // --- REGLAS POR COLECCIÓN ---

    // 1. EMPLEADOS: Cada quien lee lo suyo. Admin lee/escribe todo.
    match /employees/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // 2. SUCURSALES: Lectura pública para login, escritura Admin
    match /branches/{branchId} {
      allow read: if true; 
      allow write: if isAdmin();
    }

    // 3. PACIENTES
    match /patients/{patientId} {
      allow read, create, update: if isAuthenticated() && (isDoctor() || isSales() || isAdmin());
      allow delete: if isAdmin();
    }

    // 4. CONSULTAS (NOM-024)
    match /consultations/{consultationId} {
      allow read, create: if isDoctor();
      // Bloqueo de edición si está finalizada
      allow update: if isDoctor() && resource.data.status != 'finished';
      allow delete: if false; 
    }

    // 5. VENTAS Y PAGOS
    match /sales/{saleId} {
      allow read, create: if isAuthenticated();
      allow update: if isAdmin() || isSales(); // Para abonos
      allow delete: if isAdmin();
    }
    
    match /shifts/{shiftId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // 6. ÓRDENES DE TRABAJO (Esto faltaba y causaba el error en Dashboard)
    match /work_orders/{orderId} {
      allow read, create, update: if isAuthenticated(); // Operativo para todos
      allow delete: if isAdmin();
    }

    // 7. INVENTARIO Y PRODUCTOS (Necesario para ventas)
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // Solo admin ajusta catálogo base, stock se mueve por Cloud Functions o lógica segura
      allow update: if isAuthenticated(); // Permitir descontar stock al vender (si se hace desde cliente)
    }
    
    match /inventory_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // 8. GASTOS (Expenses)
    match /expenses/{expenseId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // 9. AUDITORÍA (Caja negra)
    match /audit_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // 10. CONFIGURACIÓN GENERAL
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // Resto por defecto cerrado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}