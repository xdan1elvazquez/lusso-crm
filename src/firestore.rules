rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE AYUDA ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/employees/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('ADMIN');
    }

    function isDoctor() {
      return hasRole('DOCTOR') || hasRole('OPTOMETRIST') || isAdmin();
    }
    
    function isSales() {
      return hasRole('SALES') || isAdmin();
    }

    // --- REGLAS POR COLECCI√ìN ---

    // 1. EMPLEADOS
    match /employees/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow read, write: if isAdmin();
    }

    // 2. SUCURSALES
    match /branches/{branchId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // 3. PACIENTES
    match /patients/{patientId} {
      allow read, create, update: if isAuthenticated() && (isDoctor() || isSales() || isAdmin());
      allow delete: if isAdmin();
    }

    // 4. CONSULTAS
    match /consultations/{consultationId} {
      allow read, create: if isDoctor();
      allow update: if isDoctor() && resource.data.status != 'finished';
      allow delete: if false; 
    }

    // 5. VENTAS Y PAGOS
    match /sales/{saleId} {
      allow read, create: if isAuthenticated();
      allow update: if isAdmin() || isSales(); 
      allow delete: if isAdmin();
    }
    
    match /shifts/{shiftId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // 6. √ìRDENES DE TRABAJO
    match /work_orders/{orderId} {
      allow read, create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // 7. INVENTARIO Y PRODUCTOS
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      allow update: if isAuthenticated(); 
    }
    
    match /inventory_logs/{logId} {
      allow read: if isAuthenticated(); 
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // 8. GASTOS
    match /expenses/{expenseId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // 9. AUDITOR√çA
    match /audit_logs/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // 10. CONFIGURACI√ìN GENERAL
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 11. LABORATORIOS
    match /labs/{labId} {
      allow read: if isAuthenticated(); 
      allow write: if isAdmin();        
    }

    // 12. EX√ÅMENES DE LA VISTA
    match /eye_exams/{examId} {
      allow read, create, update: if isAuthenticated() && (isDoctor() || isSales() || isAdmin());
      allow delete: if isAdmin();
    }

    // 13. CONTADORES DE FOLIOS
    match /counters/{counterId} {
      allow read: if isAuthenticated();
      allow update: if isAuthenticated(); 
      allow create: if isAdmin();         
    }

    // 14. LIBRO FINANCIERO
    match /finance_ledger/{entryId} {
      allow read: if isAuthenticated(); 
      allow create: if isAuthenticated(); 
      allow update, delete: if isAdmin();
    }

    // 15. MESA DE AYUDA (TICKETS)
    match /internal_tickets/{ticketId} {
      allow read, create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // 16. PROVEEDORES
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 17. DEUDAS A PROVEEDORES
    match /supplier_debts/{debtId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // 18. CORTES DE CAJA
    match /cash_counts/{countId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // 19. N√ìMINA
    match /payroll/{recordId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // üëá 20. ESTAD√çSTICAS (ESTO ARREGLA INVENTARIO) üëá
    match /stats/{statId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Necesario para recalcular stock al vender
    }

    // Resto por defecto cerrado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}